<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Capstone Group 40 - Smart Classroom</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
      body { background-color: #f8f9fa; }
      .card { border: none; border-radius: 12px; }
      .icon-lg { width: 32px; height: 32px; margin-bottom: 10px; }
    </style>
  </head>
  <body>
    
    <div class="card text-center mb-4 rounded-0 shadow-sm bg-white">
      <div class="card-body py-4">
        <h3 class="fw-bold text-primary">IoT-Based Smart Classroom</h3>
        <p class="text-muted mb-0">Environmental Monitoring & Energy Dashboard</p>
      </div>
    </div>

    <div class="container">
      
      <div class="row row-cols-2 row-cols-md-4 g-3 text-center mb-4">
          <div class="col">
            <div class="card h-100 shadow-sm p-3">
              <h6 class="text-muted small text-uppercase">Temperature</h6>
              <h2 id="temperature_text" class="fw-bold text-danger mb-0">--°C</h2>
            </div>
          </div>
          <div class="col">
            <div class="card h-100 shadow-sm p-3">
              <h6 class="text-muted small text-uppercase">Humidity</h6>
              <h2 id="humidity_text" class="fw-bold text-primary mb-0">--%</h2>
            </div>
          </div>
          <div class="col">
            <div class="card h-100 shadow-sm p-3">
              <h6 class="text-muted small text-uppercase">Light Level</h6>
              <h2 id="light_text" class="fw-bold text-warning mb-0">--</h2>
            </div>
          </div>
          <div class="col">
            <div class="card h-100 shadow-sm p-3">
              <h6 class="text-muted small text-uppercase">Air Quality</h6>
              <h2 id="co2_text" class="fw-bold text-secondary mb-0">--</h2>
            </div>
          </div>
      </div>

      <div class="row mb-4">
        <div class="col-12 col-lg-8 mb-3">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-bold text-secondary">Hourly Energy Consumption</h5>
              <span class="badge bg-primary">Today</span>
            </div>
            <div class="card-body">
              <canvas id="energyBarChart" height="200"></canvas>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-4 mb-3">
          <div class="card border-success h-100 shadow-sm">
            <div class="card-header bg-success text-white fw-bold text-center">
              Eco-Efficiency Tracker
            </div>
            <div class="card-body text-center d-flex flex-column justify-content-center">
              <h6 class="text-success text-uppercase">Total Energy Saved</h6>
              <h1 class="display-3 fw-bold my-2" id="saved_text">0.00</h1>
              <span class="fs-5 text-muted">Watt-hours (Wh)</span>
              <hr>
              <div class="d-flex justify-content-between px-3">
                <small class="text-muted">Actual Usage:</small>
                <small class="fw-bold" id="used_text">0.00 Wh</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row justify-content-center mb-5">
        <div class="col-12 col-md-8 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white text-center py-3">
              <h5 class="mb-0">Manual Control Panel</h5>
            </div>
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                  <h6 class="fw-bold mb-0">Fan Override</h6>
                  <small class="text-muted">Force Fan ON</small>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="btn-fan" style="transform: scale(1.6); cursor: pointer;">
                </div>
              </div>
              <hr class="text-secondary opacity-25">
              <div class="d-flex justify-content-between align-items-center mt-4">
                <div>
                  <h6 class="fw-bold mb-0">Light Override</h6>
                  <small class="text-muted">Force Lamp ON</small>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="btn-light" style="transform: scale(1.6); cursor: pointer;">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="text-center pt-3 pb-5">
        <p class="h6 text-muted">Last updated: <span id="last_updated" class="fw-bold text-dark">--</span></p>
      </div>

    </div>

    <script>
      // 1. FIREBASE CONFIG
      const firebaseConfig = {
          apiKey: "AIzaSyD_htAAKN1dv7fsOkO0g8IxgQRsDuIiyu4",
          authDomain: "rfid-attendance-30745.firebaseapp.com",
          databaseURL: "https://rfid-attendance-30745-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "rfid-attendance-30745",
          storageBucket: "rfid-attendance-30745.firebasestorage.app",
          messagingSenderId: "860028054162",
          appId: "1:860028054162:web:f3b05e9a5c6733bae0944b",
          measurementId: "G-XMZEQML8B9"
      };

      // Initialize Firebase (Compat Mode)
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // 2. DOM ELEMENTS
      const tempElement = document.getElementById("temperature_text");
      const humElement = document.getElementById("humidity_text");
      const co2Element = document.getElementById("co2_text");
      const lightElement = document.getElementById("light_text");
      const updatedElement = document.getElementById("last_updated");
      const savedElement = document.getElementById("saved_text");
      const usedElement = document.getElementById("used_text");
      const fanSwitch = document.getElementById("btn-fan");
      const lightSwitch = document.getElementById("btn-light");

      // 3. CHART SETUP
      const ctx = document.getElementById('energyBarChart').getContext('2d');
      const energyBarChart = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: ["00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", 
                       "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"],
              datasets: [{
                  label: 'Energy (Wh)',
                  data: new Array(24).fill(0),
                  backgroundColor: 'rgba(54, 162, 235, 0.7)',
                  borderColor: 'rgba(54, 162, 235, 1)',
                  borderWidth: 1,
                  borderRadius: 4
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                  y: { beginAtZero: true, title: { display: true, text: 'Wh' } },
                  x: { title: { display: true, text: 'Hour' }, grid: { display: false } }
              }
          }
      });

      function getTodayDateString() {
          const now = new Date();
          const yyyy = now.getFullYear();
          const mm = String(now.getMonth() + 1).padStart(2, '0');
          const dd = String(now.getDate()).padStart(2, '0');
          return `${yyyy}-${mm}-${dd}`;
      }

      // 4. LIVE UPDATES (Status Path)
      database.ref('Classroom/Status/').on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
              tempElement.innerText = (data.temperature || "--") + "°C";
              humElement.innerText = (data.humidity || "--") + "%";
              co2Element.innerText = (data.air_quality || "--");
              lightElement.innerText = (data.lighting || "--");
              updatedElement.innerText = data.updated || "Unknown";

              if (data.energy_saved !== undefined) {
                  savedElement.innerText = parseFloat(data.energy_saved).toFixed(2);
              }
              if (data.energy_used !== undefined) {
                  usedElement.innerText = parseFloat(data.energy_used).toFixed(2) + " Wh";
              }
          }
      });

      // 5. GRAPH UPDATES (History Path)
      const todayStr = getTodayDateString();
      database.ref('Classroom/EnergyHistory/' + todayStr).on('value', (snapshot) => {
          const data = snapshot.val();
          const hourlyTotals = new Array(24).fill(0);

          if (data) {
              Object.values(data).forEach(log => {
                  if (log.time && log.wh) {
                      const hourIndex = parseInt(log.time.split(':')[0]);
                      if (hourIndex >= 0 && hourIndex < 24) {
                          hourlyTotals[hourIndex] += parseFloat(log.wh);
                      }
                  }
              });
          }
          energyBarChart.data.datasets[0].data = hourlyTotals;
          energyBarChart.update();
      });

      // 6. CONTROL SWITCHES
      const controlRef = database.ref('Classroom/Control/');
      controlRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
              if (fanSwitch) fanSwitch.checked = (data.fan === true);
              if (lightSwitch) lightSwitch.checked = (data.light === true);
          }
      });

      fanSwitch.addEventListener('change', (e) => {
          controlRef.update({ fan: e.target.checked })
            .catch(() => { e.target.checked = !e.target.checked; });
      });

      lightSwitch.addEventListener('change', (e) => {
          controlRef.update({ light: e.target.checked })
            .catch(() => { e.target.checked = !e.target.checked; });
      });

    </script>
  </body>
</html>
